name: Release

on:
    push:
        branches:
            - main

permissions:
    contents: write

jobs:
    lint:
        uses: ./.github/workflows/lint.yml
    tests:
        uses: ./.github/workflows/tests.yml

    release:
        runs-on: ubuntu-latest
        needs: [lint, tests]
        steps:
            - name: Checkout
              uses: actions/checkout@v3
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  cache: npm
                  node-version: 18

            - name: Install Dependencies
              run: npm ci

            - name: Bump Version
              id: bump_version
              run: |
                  git config --global user.name "github-actions[bot]"
                  git config --global user.email "github-actions[bot]@users.noreply.github.com"
                  VERSION=$(npm version patch -m "chore(release): %s [skip ci]")
                  echo "version=$VERSION" >> $GITHUB_OUTPUT

            - name: Push Changes
              run: |
                  git push
                  git push --tags

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: ${{ steps.bump_version.outputs.version }}
                  generate_release_notes: true
